services:
  protonvpn:
    image: ghcr.io/tprasadtp/protonwire:latest
    container_name: protonvpn
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    env_file:
      - ../../.env.staging
    sysctls:
      net.ipv4.conf.all.rp_filter: 2
      net.ipv6.conf.all.disable_ipv6: 1
    volumes:
      - type: tmpfs
        target: /tmp
      - type: bind
        source: private.key
        target: /etc/protonwire/private-key
        read_only: true
    tty: true

  browserless:
    image: ghcr.io/browserless/chromium:latest
    container_name: browserless
    network_mode: "service:protonvpn"
    environment:
      - DEFAULT_BLOCK_ADS=true
      - MAX_CONCURRENT_SESSIONS=5
      - PREBOOT_CHROME=true

  caddy:
    image: caddy:latest
    container_name: caddy-proxy
    network_mode: "service:protonvpn"
    command: >
      caddy reverse-proxy
      --from :3000
      --to http://127.0.0.1:3000
      --header-up Host {host}
      --header-up Upgrade {>Upgrade}
      --header-up Connection {>Connection}
    tty: true

  app:
    build:
      context: ../../
      dockerfile: docker/staging/Dockerfile
    container_name: manga-xr-app
    env_file:
      - ../../.env.staging
    depends_on:
      - caddy
    networks:
      - manga-network
    ports:
      - "4000:3000"

  mongodb-primary:
    image: bitnami/mongodb:latest
    container_name: mongodb-primary
    environment:
      - MONGODB_REPLICA_SET_NAME=rs0
      - MONGODB_ADVERTISED_HOSTNAME=mongodb-primary
      - MONGODB_REPLICA_SET_MODE=primary
      - MONGODB_ROOT_PASSWORD=password
      - MONGODB_REPLICA_SET_KEY=replicasetkey123
    ports:
      - "127.0.0.1:27017:27017"
    volumes:
      - manga-xr-staging-db:/bitnami
    networks:
      - manga-network

  mongodb-secondary:
    image: bitnami/mongodb:latest
    container_name: mongodb-secondary
    depends_on:
      - mongodb-primary
    environment:
      - MONGODB_REPLICA_SET_NAME=rs0
      - MONGODB_ADVERTISED_HOSTNAME=mongodb-secondary
      - MONGODB_REPLICA_SET_MODE=secondary
      - MONGODB_INITIAL_PRIMARY_HOST=mongodb-primary
      - MONGODB_INITIAL_PRIMARY_PORT_NUMBER=27017
      - MONGODB_INITIAL_PRIMARY_ROOT_PASSWORD=password
      - MONGODB_REPLICA_SET_KEY=replicasetkey123
    ports:
      - "127.0.0.1:27027:27017"
    networks:
      - manga-network

  mongodb-arbiter:
    image: bitnami/mongodb:latest
    container_name: mongodb-arbiter
    depends_on:
      - mongodb-primary
    environment:
      - MONGODB_REPLICA_SET_NAME=rs0
      - MONGODB_ADVERTISED_HOSTNAME=mongodb-arbiter
      - MONGODB_REPLICA_SET_MODE=arbiter
      - MONGODB_INITIAL_PRIMARY_HOST=mongodb-primary
      - MONGODB_INITIAL_PRIMARY_PORT_NUMBER=27017
      - MONGODB_INITIAL_PRIMARY_ROOT_PASSWORD=password
      - MONGODB_REPLICA_SET_KEY=replicasetkey123
    ports:
      - "127.0.0.1:27037:27017"
    networks:
      - manga-network

volumes:
  manga-xr-staging-db:
    driver: local

networks:
  manga-network:
    driver: bridge
